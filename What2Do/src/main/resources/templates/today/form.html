<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>활동 추천 설문</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_KEY&libraries=services"></script>
</head>
<style>
    .sgg, .sgg2 {
        width: 253px;
    }

    .text-center button {
        background-color: #1a2e45;
    }

    #detail {
        position: absolute;
        top: 203px;
        right: 473px;
    }

    #infoBox {
        position: absolute;
        top: 210px;
        left: 790px;
        width: 300px;
        height: 120px;
        background-color: white;
        border: 1px solid #ccc;
        padding-left: 5px;
        padding-top: 23px;
        border-radius: 10px;
        text-align: center;
    }
</style>
<body>

<div th:replace="~{fragments/top :: headerFragment}"></div>
<div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow">

    <div style="flex; align-items: center;">
        <h2 class="text-2xl font-semibold mb-6 text-center" id="detail2">오늘의 상태를 알려주세요</h2>
        <img src="img/정보버튼.png" onclick="detail()" width="15px" height="15px" id="detail">
        <div id="infoBox" style="display: none;">
            <p>오늘 뭐하지? 기능은<br>
                고객 정보기반 랜덤 활동 추천 <br>
                시스템입니다.</p>
        </div>
    </div>

    <form action="/recommend" method="get">
        <div class="mb-4">
            <label class="block mb-1 font-medium">현재 기분</label>
            <select name="mood" class="w-full border p-2 rounded">
                <option value="기분좋아요">😊 기분 좋아요</option>
                <option value="그냥그래요">😐 그냥 그래요</option>
                <option value="피곤해요">😴 피곤해요</option>
                <option value="스트레스">😑 스트레스</option>
                <option value="우울해요">😥 우울 해요</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block mb-1 font-medium">선호하는 활동 유형</label>
            <select class="w-full border p-2 rounded" name="tags">
                <option value="실내">실내</option>
                <option value="실외">실외</option>
                <option value="문화/예술">문화/예술</option>
                <option value="운동">운동</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block mb-1 font-medium">동행인</label>
            <select class="w-full border p-2 rounded" name="companions">
                <option value="혼자">혼자</option>
                <option value="친구">친구</option>
                <option value="연인">연인</option>
                <option value="가족">가족</option>
            </select>
        </div>

        <!-- 날씨 (자동 설정) -->
        <div class="mb-4">
            <label class="block mb-1 font-medium">날씨</label>
            <select id="weatherSelect" class="w-full border p-2 rounded text-blue-700 font-semibold bg-gray-100" disabled>
                <option value="">날씨를 선택 중...</option>
                <option value="맑음">☀️ 맑음</option>
                <option value="구름많음">⛅ 구름많음</option>
                <option value="흐림">☁️ 흐림</option>
                <option value="비">🌧️ 비</option>
                <option value="소나기">🌦️ 소나기</option>
                <option value="눈">❄️ 눈</option>
                <option value="비/눈">🌨️ 비/눈</option>
            </select>
            <!-- 실제 form 전송용 -->
            <input type="hidden" name="weather" id="weatherInput">
        </div>

        <!-- 위치 선택 -->
        <div class="mb-6">
            <label class="block mb-1 font-medium">현재 위치 (도/시)</label>
            <span>
                <select class="sgg border p-2 rounded" name="area" onchange="cityList(this.value)" required>
                    <option value="" disabled selected>도/광역시를 선택하세요</option>
                    <option value="서울특별시">서울특별시</option>
                    <option value="경기도">경기도</option>
                    <option value="인천광역시">인천광역시</option>
                    <option value="강원도">강원도</option>
                    <option value="충청북도">충청북도</option>
                    <option value="충청남도">충청남도</option>
                    <option value="세종특별자치시">세종특별자치시</option>
                    <option value="대전광역시">대전광역시</option>
                    <option value="경상북도">경상북도</option>
                    <option value="경상남도">경상남도</option>
                    <option value="대구광역시">대구광역시</option>
                    <option value="전라북도">전라북도</option>
                    <option value="전라남도">전라남도</option>
                    <option value="광주광역시">광주광역시</option>
                    <option value="부산광역시">부산광역시</option>
                    <option value="울산광역시">울산광역시</option>
                    <option value="제주도">제주도</option>
                </select>
                <select class="sgg2 border p-2 rounded" name="city" id="cityL" onchange="onLocationChange()"></select>
            </span>
        </div>

        <div class="text-center">
            <button type="submit" class="px-6 py-3 text-white rounded-xl transition">추천 확인하기</button>
        </div>
    </form>
</div>
<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script>
    const SERVICE_KEY = "HI4uJdHAz5JRb2JVDzardd1U0%2FYqhiVizmMqkHND%2FsE19hTvA3QhWCCbHs0FbiMc%2Bscyz1zQxWkuoreAo6ywRQ%3D%3D"; // 필수!

    function detail() {
        const infoBox = document.getElementById("infoBox");
        infoBox.style.display = infoBox.style.display === "none" ? "block" : "none";
    }

    function cityList(area) {
        const citySelect = document.getElementById('cityL');
        citySelect.innerHTML = "";
        $.ajax({
            type: "get",
            url: "/cityListV",
            data: { "area3": area },
            success: function (clist) {
                clist.forEach(city => {
                    const option = document.createElement("option");
                    option.value = city.city;
                    option.textContent = city.city;
                    citySelect.appendChild(option);
                });

                // ✅ 도시 select가 변경될 때 날씨 조회되도록 바인딩
                citySelect.onchange = onLocationChange;
            },
            error: function () {
                alert("도시 목록을 가져오지 못했습니다.");
            }
        });
    }

    function onLocationChange() {
        const area = document.querySelector("select[name='area']").value;
        const city = document.querySelector("select[name='city']").value;
        if (!area || !city) return;

        const query = `${area} ${city}`;
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(query, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                fetchWeather(result[0].y, result[0].x);
            }
        });
    }

    function dfs_xy_conv(code, v1, v2) {
        const RE = 6371.00877, GRID = 5.0, SLAT1 = 30.0, SLAT2 = 60.0, OLON = 126.0, OLAT = 38.0, XO = 43, YO = 136;
        const DEGRAD = Math.PI / 180.0;
        const re = RE / GRID;
        const slat1 = SLAT1 * DEGRAD, slat2 = SLAT2 * DEGRAD;
        const olon = OLON * DEGRAD, olat = OLAT * DEGRAD;

        let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        let sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        let ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);

        const ra = Math.tan(Math.PI * 0.25 + v1 * DEGRAD * 0.5);
        const r = re * sf / Math.pow(ra, sn);
        let theta = v2 * DEGRAD - olon;
        theta *= sn;
        const x = Math.floor(r * Math.sin(theta) + XO + 0.5);
        const y = Math.floor(ro - r * Math.cos(theta) + YO + 0.5);
        return { x, y };
    }

    function interpretValue(category, value) {
        if (category === "SKY") return { "1": "맑음", "3": "구름많음", "4": "흐림" }[value] || "맑음";
        if (category === "PTY") return {
            "0": "없음", "1": "비", "2": "비/눈", "3": "눈", "4": "소나기"
        }[value] || "없음";
        return value;
    }

    function fetchWeather(lat, lon) {
    const { x, y } = dfs_xy_conv("toXY", lat, lon);
    const now = new Date();
    const ymd = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2);
    let hour = now.getHours();
    if (now.getMinutes() < 30) hour--;
    const time = ('0' + hour).slice(-2) + "30";

    const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtFcst?serviceKey=${SERVICE_KEY}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${ymd}&base_time=${time}&nx=${x}&ny=${y}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const items = data.response.body.items.item;

            const latest = items.reduce((acc, item) => {
                if (!acc[item.category] || acc[item.category].fcstTime < item.fcstTime) {
                    acc[item.category] = item;
                }
                return acc;
            }, {});

            const skyItem = latest["SKY"];
            const ptyItem = latest["PTY"];

            const sky = interpretValue("SKY", skyItem?.fcstValue);
            const pty = interpretValue("PTY", ptyItem?.fcstValue);
            const finalWeather = pty !== "없음" ? pty : sky;

            // select에서 자동 선택
            const weatherSelect = document.getElementById("weatherSelect");
            const options = weatherSelect.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === finalWeather) {
                    weatherSelect.selectedIndex = i;
                    break;
                }
            }

            document.getElementById("weatherInput").value = finalWeather;
            console.log("자동 선택된 날씨:", finalWeather);
        })
        .catch(err => {
            console.error("날씨 조회 실패:", err);
            alert("날씨 정보를 불러올 수 없습니다.");
        });
}
</script>

</body>
</html>
