<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>í™œë™ ì¶”ì²œ ì„¤ë¬¸</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_KEY&libraries=services"></script>
</head>
<style>
    .sgg, .sgg2 {
        width: 253px;
    }

    .text-center button {
        background-color: #1a2e45;
    }

    #detail {
        position: absolute;
        top: 203px;
        right: 473px;
    }

    #infoBox {
        position: absolute;
        top: 210px;
        left: 790px;
        width: 300px;
        height: 120px;
        background-color: white;
        border: 1px solid #ccc;
        padding-left: 5px;
        padding-top: 23px;
        border-radius: 10px;
        text-align: center;
    }
</style>
<body>

<div th:replace="~{fragments/top :: headerFragment}"></div>
<div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow">

    <div style="flex; align-items: center;">
        <h2 class="text-2xl font-semibold mb-6 text-center" id="detail2">ì˜¤ëŠ˜ì˜ ìƒíƒœë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</h2>
        <img src="img/ì •ë³´ë²„íŠ¼.png" onclick="detail()" width="15px" height="15px" id="detail">
        <div id="infoBox" style="display: none;">
            <p>ì˜¤ëŠ˜ ë­í•˜ì§€? ê¸°ëŠ¥ì€<br>
                ê³ ê° ì •ë³´ê¸°ë°˜ ëœë¤ í™œë™ ì¶”ì²œ <br>
                ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p>
        </div>
    </div>

    <form action="/recommend" method="get">
        <div class="mb-4">
            <label class="block mb-1 font-medium">í˜„ì¬ ê¸°ë¶„</label>
            <select name="mood" class="w-full border p-2 rounded">
                <option value="ê¸°ë¶„ì¢‹ì•„ìš”">ğŸ˜Š ê¸°ë¶„ ì¢‹ì•„ìš”</option>
                <option value="ê·¸ëƒ¥ê·¸ë˜ìš”">ğŸ˜ ê·¸ëƒ¥ ê·¸ë˜ìš”</option>
                <option value="í”¼ê³¤í•´ìš”">ğŸ˜´ í”¼ê³¤í•´ìš”</option>
                <option value="ìŠ¤íŠ¸ë ˆìŠ¤">ğŸ˜‘ ìŠ¤íŠ¸ë ˆìŠ¤</option>
                <option value="ìš°ìš¸í•´ìš”">ğŸ˜¥ ìš°ìš¸ í•´ìš”</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block mb-1 font-medium">ì„ í˜¸í•˜ëŠ” í™œë™ ìœ í˜•</label>
            <select class="w-full border p-2 rounded" name="tags">
                <option value="ì‹¤ë‚´">ì‹¤ë‚´</option>
                <option value="ì‹¤ì™¸">ì‹¤ì™¸</option>
                <option value="ë¬¸í™”/ì˜ˆìˆ ">ë¬¸í™”/ì˜ˆìˆ </option>
                <option value="ìš´ë™">ìš´ë™</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block mb-1 font-medium">ë™í–‰ì¸</label>
            <select class="w-full border p-2 rounded" name="companions">
                <option value="í˜¼ì">í˜¼ì</option>
                <option value="ì¹œêµ¬">ì¹œêµ¬</option>
                <option value="ì—°ì¸">ì—°ì¸</option>
                <option value="ê°€ì¡±">ê°€ì¡±</option>
            </select>
        </div>

        <!-- ë‚ ì”¨ (ìë™ ì„¤ì •) -->
        <div class="mb-4">
            <label class="block mb-1 font-medium">ë‚ ì”¨</label>
            <select id="weatherSelect" class="w-full border p-2 rounded text-blue-700 font-semibold bg-gray-100" disabled>
                <option value="">ë‚ ì”¨ë¥¼ ì„ íƒ ì¤‘...</option>
                <option value="ë§‘ìŒ">â˜€ï¸ ë§‘ìŒ</option>
                <option value="êµ¬ë¦„ë§ìŒ">â›… êµ¬ë¦„ë§ìŒ</option>
                <option value="íë¦¼">â˜ï¸ íë¦¼</option>
                <option value="ë¹„">ğŸŒ§ï¸ ë¹„</option>
                <option value="ì†Œë‚˜ê¸°">ğŸŒ¦ï¸ ì†Œë‚˜ê¸°</option>
                <option value="ëˆˆ">â„ï¸ ëˆˆ</option>
                <option value="ë¹„/ëˆˆ">ğŸŒ¨ï¸ ë¹„/ëˆˆ</option>
            </select>
            <!-- ì‹¤ì œ form ì „ì†¡ìš© -->
            <input type="hidden" name="weather" id="weatherInput">
        </div>

        <!-- ìœ„ì¹˜ ì„ íƒ -->
        <div class="mb-6">
            <label class="block mb-1 font-medium">í˜„ì¬ ìœ„ì¹˜ (ë„/ì‹œ)</label>
            <span>
                <select class="sgg border p-2 rounded" name="area" onchange="cityList(this.value)" required>
                    <option value="" disabled selected>ë„/ê´‘ì—­ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                    <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
                    <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
                    <option value="ê°•ì›ë„">ê°•ì›ë„</option>
                    <option value="ì¶©ì²­ë¶ë„">ì¶©ì²­ë¶ë„</option>
                    <option value="ì¶©ì²­ë‚¨ë„">ì¶©ì²­ë‚¨ë„</option>
                    <option value="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
                    <option value="ëŒ€ì „ê´‘ì—­ì‹œ">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                    <option value="ê²½ìƒë¶ë„">ê²½ìƒë¶ë„</option>
                    <option value="ê²½ìƒë‚¨ë„">ê²½ìƒë‚¨ë„</option>
                    <option value="ëŒ€êµ¬ê´‘ì—­ì‹œ">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                    <option value="ì „ë¼ë¶ë„">ì „ë¼ë¶ë„</option>
                    <option value="ì „ë¼ë‚¨ë„">ì „ë¼ë‚¨ë„</option>
                    <option value="ê´‘ì£¼ê´‘ì—­ì‹œ">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                    <option value="ë¶€ì‚°ê´‘ì—­ì‹œ">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                    <option value="ìš¸ì‚°ê´‘ì—­ì‹œ">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                    <option value="ì œì£¼ë„">ì œì£¼ë„</option>
                </select>
                <select class="sgg2 border p-2 rounded" name="city" id="cityL" onchange="onLocationChange()"></select>
            </span>
        </div>

        <div class="text-center">
            <button type="submit" class="px-6 py-3 text-white rounded-xl transition">ì¶”ì²œ í™•ì¸í•˜ê¸°</button>
        </div>
    </form>
</div>
<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script>
    const SERVICE_KEY = "HI4uJdHAz5JRb2JVDzardd1U0%2FYqhiVizmMqkHND%2FsE19hTvA3QhWCCbHs0FbiMc%2Bscyz1zQxWkuoreAo6ywRQ%3D%3D"; // í•„ìˆ˜!

    function detail() {
        const infoBox = document.getElementById("infoBox");
        infoBox.style.display = infoBox.style.display === "none" ? "block" : "none";
    }

    function cityList(area) {
        const citySelect = document.getElementById('cityL');
        citySelect.innerHTML = "";
        $.ajax({
            type: "get",
            url: "/cityListV",
            data: { "area3": area },
            success: function (clist) {
                clist.forEach(city => {
                    const option = document.createElement("option");
                    option.value = city.city;
                    option.textContent = city.city;
                    citySelect.appendChild(option);
                });

                // âœ… ë„ì‹œ selectê°€ ë³€ê²½ë  ë•Œ ë‚ ì”¨ ì¡°íšŒë˜ë„ë¡ ë°”ì¸ë”©
                citySelect.onchange = onLocationChange;
            },
            error: function () {
                alert("ë„ì‹œ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    function onLocationChange() {
        const area = document.querySelector("select[name='area']").value;
        const city = document.querySelector("select[name='city']").value;
        if (!area || !city) return;

        const query = `${area} ${city}`;
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(query, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                fetchWeather(result[0].y, result[0].x);
            }
        });
    }

    function dfs_xy_conv(code, v1, v2) {
        const RE = 6371.00877, GRID = 5.0, SLAT1 = 30.0, SLAT2 = 60.0, OLON = 126.0, OLAT = 38.0, XO = 43, YO = 136;
        const DEGRAD = Math.PI / 180.0;
        const re = RE / GRID;
        const slat1 = SLAT1 * DEGRAD, slat2 = SLAT2 * DEGRAD;
        const olon = OLON * DEGRAD, olat = OLAT * DEGRAD;

        let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        let sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        let ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);

        const ra = Math.tan(Math.PI * 0.25 + v1 * DEGRAD * 0.5);
        const r = re * sf / Math.pow(ra, sn);
        let theta = v2 * DEGRAD - olon;
        theta *= sn;
        const x = Math.floor(r * Math.sin(theta) + XO + 0.5);
        const y = Math.floor(ro - r * Math.cos(theta) + YO + 0.5);
        return { x, y };
    }

    function interpretValue(category, value) {
        if (category === "SKY") return { "1": "ë§‘ìŒ", "3": "êµ¬ë¦„ë§ìŒ", "4": "íë¦¼" }[value] || "ë§‘ìŒ";
        if (category === "PTY") return {
            "0": "ì—†ìŒ", "1": "ë¹„", "2": "ë¹„/ëˆˆ", "3": "ëˆˆ", "4": "ì†Œë‚˜ê¸°"
        }[value] || "ì—†ìŒ";
        return value;
    }

    function fetchWeather(lat, lon) {
    const { x, y } = dfs_xy_conv("toXY", lat, lon);
    const now = new Date();
    const ymd = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) + ('0' + now.getDate()).slice(-2);
    let hour = now.getHours();
    if (now.getMinutes() < 30) hour--;
    const time = ('0' + hour).slice(-2) + "30";

    const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtFcst?serviceKey=${SERVICE_KEY}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${ymd}&base_time=${time}&nx=${x}&ny=${y}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const items = data.response.body.items.item;

            const latest = items.reduce((acc, item) => {
                if (!acc[item.category] || acc[item.category].fcstTime < item.fcstTime) {
                    acc[item.category] = item;
                }
                return acc;
            }, {});

            const skyItem = latest["SKY"];
            const ptyItem = latest["PTY"];

            const sky = interpretValue("SKY", skyItem?.fcstValue);
            const pty = interpretValue("PTY", ptyItem?.fcstValue);
            const finalWeather = pty !== "ì—†ìŒ" ? pty : sky;

            // selectì—ì„œ ìë™ ì„ íƒ
            const weatherSelect = document.getElementById("weatherSelect");
            const options = weatherSelect.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === finalWeather) {
                    weatherSelect.selectedIndex = i;
                    break;
                }
            }

            document.getElementById("weatherInput").value = finalWeather;
            console.log("ìë™ ì„ íƒëœ ë‚ ì”¨:", finalWeather);
        })
        .catch(err => {
            console.error("ë‚ ì”¨ ì¡°íšŒ ì‹¤íŒ¨:", err);
            alert("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        });
}
</script>

</body>
</html>
