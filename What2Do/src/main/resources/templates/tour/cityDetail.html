<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text>ê°€ê²Œ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .thumbnail {
            width: 100%;
            height: 580px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .overview {
            font-size: 1.1rem;
            color: #374151;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .address {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 36px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 16px;
            border-bottom: 2px solid #3b82f6;
            display: inline-block;
            padding-bottom: 4px;
            color: #1e40af;
        }

        .reviews {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 12px;
        }

        .review-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 0;
            font-size: 0.95rem;
            color: #374151;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .map_wrap {
     position:relative;width:600px;height:350px;
     }
        .title {
        font-weight:bold;display:block;
        }
        .hAddr {
        position:absolute;left:10px;top:10px;border-radius: 2px;background:#fff;background:rgba(255,255,255,0.8);z-index:1;padding:5px;
        }
        #centerAddr {
        display:block;margin-top:2px;font-weight: normal;
        }
        .bAddr {
        padding:5px;text-overflow: ellipsis;overflow: hidden;white-space: nowrap; font-size: 15px;
        }
    .title {
    font-size: 20px;
    }

          /* ì „ì²´ ëŒ“ê¸€ ì„¹ì…˜ ë°•ìŠ¤ */
      .comment-section {
        max-width: 800px; /* ìµœëŒ€ ë„ˆë¹„ */
        margin: 40px auto; /* ê°€ìš´ë° ì •ë ¬ + ìœ„ ì—¬ë°± */
        background-color: #ffffff; /* í° ë°°ê²½ */
        padding: 24px; /* ë‚´ë¶€ ì—¬ë°± */
        border-radius: 16px; /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì */
      }

      /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
      .section-title {
        font-size: 1.5rem; /* ê¸€ì í¬ê¸° */
        font-weight: 700; /* êµµì€ ê¸€ì”¨ */
        margin-bottom: 16px; /* ì•„ë˜ ì—¬ë°± */
        color: #1f2937; /* ì§™ì€ íšŒìƒ‰ í…ìŠ¤íŠ¸ (gray-800) */
      }

      /* ëŒ“ê¸€ í¼ ì•ˆì˜ textarea ìŠ¤íƒ€ì¼ */
      .comment-form textarea {
        width: 90%; /* ê°€ë¡œ ì „ì²´ */
        border: 2px solid #d1d5db; /* ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ (gray-300) */
        border-radius: 12px; /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
        padding: 12px 16px; /* ì•ˆìª½ ì—¬ë°± */
        font-size: 16px; /* ê¸€ì í¬ê¸° */
        resize: vertical; /* ì„¸ë¡œ í¬ê¸° ì¡°ì ˆë§Œ í—ˆìš© */
        transition: border 0.3s ease; /* í…Œë‘ë¦¬ ë³€í™” ë¶€ë“œëŸ½ê²Œ */
        box-shadow: 0 2px 6px rgba(0,0,0,0.05); /* ì•½í•œ ê·¸ë¦¼ì */
      }

      /* textarea í¬ì»¤ìŠ¤ ì‹œ ìŠ¤íƒ€ì¼ */
      .comment-form textarea:focus {
        outline: none; /* ê¸°ë³¸ ì™¸ê³½ì„  ì œê±° */
        border-color: #3b82f6; /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ (blue-500) */
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* íŒŒë€ìƒ‰ ê°•ì¡° ë§ */
      }

      /* ëŒ“ê¸€ ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .comment-form button {
        margin-top: 12px; /* ìœ„ìª½ ì—¬ë°± */
        background-color: #3b82f6; /* ê¸°ë³¸ íŒŒë€ìƒ‰ ë°°ê²½ */
        color: white; /* í°ìƒ‰ í…ìŠ¤íŠ¸ */
        font-weight: 600; /* êµµì€ ê¸€ì”¨ */
        font-size: 16px;
        padding: 10px 24px; /* ì•ˆìª½ ì—¬ë°± */
        border: none; /* ê¸°ë³¸ í…Œë‘ë¦¬ ì œê±° */
        border-radius: 10px; /* ë‘¥ê·¼ ë²„íŠ¼ */
        cursor: pointer; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì†ê°€ë½ ì•„ì´ì½˜ */
        transition: background-color 0.3s ease; /* ë°°ê²½ìƒ‰ ì „í™˜ ë¶€ë“œëŸ½ê²Œ */
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); /* ë²„íŠ¼ ê·¸ë¦¼ì */
      }

      /* ë²„íŠ¼ ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ */
      .comment-form button:hover {
        background-color: #2563eb; /* ì¢€ ë” ì§„í•œ íŒŒë‘ (blue-600) */
      }

           .comment-section {
        max-width: 700px;
        margin: 20px auto;
        font-family: 'Arial', sans-serif;
      }

      .comment-box {
        border-bottom: 1px solid #eee;
        padding: 16px 0;
        display: flex;
        flex-direction: column;
      }

      .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .comment-user {
        font-weight: bold;
        color: #333;
      }

      .comment-date {
        font-size: 0.85em;
        color: #888;
      }

      .comment-content {
        font-size: 1em;
        color: #444;
        white-space: pre-line;
      }

      .comment-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 16px;
        border-bottom: 2px solid #ddd;
        padding-bottom: 6px;
      }
      #heartBtn {
        cursor: pointer;
        transition: fill 0.3s, stroke 0.3s;
      }

      #heartBtn.liked {
        fill: red;
        stroke: red;
      }




    </style>
</head>
<body>

<div th:replace="~{fragments/top :: headerFragment}"></div>

<div class="container">

    <div class="title" th:text="${tour.title}"></div>

    <img th:if="${tour.firstimage != null}" th:src="${tour.firstimage}" alt="ì‚¬ì§„" class="thumbnail"/>

    <div class="overview" th:text="${tour.overview}"></div>

    <div class="address" th:text="${tour.addr1}"></div>

    <div class="map_wrap">
        <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
        <div class="hAddr"></div>
    </div>
    <svg id="heartBtn" width="24" height="24" fill="none"
         stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
         viewBox="0 0 24 24" th:onclick="|likeT(${tour.id})|" th:classappend="${like} ? 'liked'">
        <path d="M12 21s-6.4-5.3-9-9c-2-3 0-7 4-7 2.1 0 3.4 1.4 5 3 1.6-1.6 2.9-3 5-3 4 0 6 4 4 7-2.6 3.7-9 9-9 9z"/>
    </svg>
    <span class="like-count" id="CNT" th:text="${tour.like_count}">0</span>


    <div class="comment-section">
        <div class="comment-title">ëŒ“ê¸€</div>

        <div th:each="clist : ${clist}" class="comment-box">
            <div class="comment-header">
                <span class="comment-user" th:text="${clist?.user}"></span>
                <span class="comment-date" th:text="${#strings.substring(clist?.indate,0,16)}"></span>
                <button th:if="${session.user.id} == ${clist.user}" th:onclick="deleteComment([[${clist.no}]])" id="deletebtn">âœ–</button>
                <button th:if="${session.user.id} == ${clist.user}" th:onclick="modifyComment([[${clist.no}]])" id="editbtn">ìˆ˜ì •</button>
            </div>
            <div class="comment-content" th:text="${clist?.content}" th:id="'content-' + ${clist.no}"></div>
        </div>
    </div>

    <form th:action="@{/commentR(tour_id=${tour.id})}" onsubmit="return inpValidateFn();" method="post" class="comment-form">
        <textarea name="content" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." id="contentB"></textarea>
        <input type="hidden" th:value="${tour.id}" name="tour_id" id="tour_id">
        <input type="hidden" th:value="${session.user.id}" name="user_id">
        <button type="submit" >ëŒ“ê¸€ ì €ì¥</button>
    </form>
</div>
<!--  <div class="section-title">ë¦¬ë·°</div>-->
<!--<div class="section" th:if="${answer == null and session.user?.role == 'ADMIN'}">-->
<!--  <div class="reviews">-->
<!--    <div class="review-item">ì¢‹ì•˜ì–´ìš”! ë¶„ìœ„ê¸° êµ¿ğŸ‘</div>-->
<!--    <div class="review-item">ì§ì›ë¶„ì´ ì¹œì ˆí–ˆì–´ìš”.</div>-->
<!--    <div class="review-item">ì¬ë°©ë¬¸ì˜ì‚¬ ìˆìŠµë‹ˆë‹¤ :)</div>-->
<!--    &lt;!&ndash; ì¶”í›„ ë¦¬ë·°ê°€ ìˆì„ ê²½ìš° ë°˜ë³µ ì¶œë ¥ ê°€ëŠ¥ &ndash;&gt;-->
<!--  </div>-->


<div th:replace="~{fragments/footer :: footerFragment}"></div>

</body>
</html>

<script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=fca66437ffd757b4f7019de36217ec4b&libraries=services"></script>

<script>
    window.onload = function () {
    var ps = new kakao.maps.services.Places();
    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng([[${tour.mapy}]],[[${tour.mapx}]] ),
            level: 1
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var geocoder = new kakao.maps.services.Geocoder();
    var marker = new kakao.maps.Marker();
    var infowindow = new kakao.maps.InfoWindow({ zindex: 1 });

    // ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œë¡œ ì£¼ì†Œ í‘œì‹œ
    searchAddrFromCoords(map.getCenter(), displayCenterInfo);

    // ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œë¡œ ë§ˆì»¤ ë° ì£¼ì†Œ í‘œì‹œ
    searchDetailAddrFromCoords(map.getCenter(), showMarkerWithAddress);

    // ì§€ë„ë¥¼ í´ë¦­í–ˆì„ ë•Œë„ ë™ì¼í•˜ê²Œ ì‹¤í–‰
  <!--  kakao.maps.event.addListener(map, 'click', function (mouseEvent) {-->
  <!--      searchDetailAddrFromCoords(mouseEvent.latLng, showMarkerWithAddress);-->
  <!--  });-->

    function searchAddrFromCoords(coords, callback) {
        geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);
    }

    function searchDetailAddrFromCoords(coords, callback) {
        geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
    }

    function displayCenterInfo(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            var infoDiv = document.getElementById('centerAddr');
            for (var i = 0; i < result.length; i++) {
                if (result[i].region_type === 'H') {
                    infoDiv.innerHTML = result[i].address_name;
                    break;
                }
            }
        }
    }

    // ì¤‘ì‹¬ì¢Œí‘œë‚˜ í´ë¦­ ì‹œ ë§ˆì»¤ + ì£¼ì†Œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function showMarkerWithAddress(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            var detailAddr = !!result[0].road_address
                ? '<div>ë„ë¡œëª…ì£¼ì†Œ : ' + result[0].road_address.address_name + '</div>'
                : '';
            detailAddr += '<div>ì§€ë²ˆ ì£¼ì†Œ : ' + result[0].address.address_name + '</div>';

            var content = '<div class="bAddr">' +
                '<span class="title">[[${tour.title}]]</span>' +
                detailAddr + '</div>';

            marker.setPosition(map.getCenter()); // í˜„ì¬ ì¤‘ì‹¬ì¢Œí‘œ
            marker.setMap(map);
            infowindow.setContent(content);
            infowindow.open(map, marker);
        }
    }
    };

    function deleteComment(no){
    if(confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
       $.ajax({
          type:"post",
          url: "/deleteC",
          data:
          { no : no },
         success: function() {
              window.location.reload();
          },
          error: function() {
           alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
         }
        });
        }
    }

      function modifyComment(no){
       $.ajax({
          type:"post",
          url: "/modifyC",
          data:
          { no : no },
         success: function(comment) {
              var newComment=$("#content-"+no).html("<input type='text' value='"+comment+"'><button id='btnUpdate'>ìˆ˜ì •í•˜ê¸°</button>")
          },
          error: function() {
           alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
         }
        });
    }
      $(document).on('click','#btnUpdate',function(){
        const no = $(this).closest('.comment-box').find('.comment-content').attr('id').split('-')[1];
        const newComment = $(this).prev('input').val();
       $.ajax({
          type:"post",
          url: "/updateC",
          data:
          { no : no,
            newComment : newComment},
         success: function() {
              window.location.reload();
          },
          error: function() {
           alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
         }
        });

      })


    const heart = document.getElementById('heartBtn');
    function likeT(num) {
      $.ajax({
        type: "post",
        url: "/likeT",
        data:
        { "num" : num },
        success: function(likeAll) {
          $("#CNT").text(likeAll.likeCnt);
           if (likeAll.like ==false) {
          heart.classList.add('liked');
        } else {
          heart.classList.remove('liked');
        }
      },
        error: function() {
          alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    }

  function inpValidateFn(){
      var contentB = $('#contentB').val().trim();
      if(contentB.length == 0){
         return false;
      }else{
         return true;
      }
  }




</script>